<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<title>HTML Tidy: The LibTidy API and Namespacing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HTML Tidy
   &#160;<span id="projectnumber">5.5.66</span>
   </div>
   <div id="projectbrief">The HTACG Tidy HTML Project</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('api_namespace.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The LibTidy API and Namespacing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Introduction</h2>
<p>If you're just getting started working with <code>LibTidy</code>, some of the design choices may seem overwhelming if you're not a seasoned C veteran. Hopefully this article will give a decent overview, encouraging you to explore and contribute to the <code>LibTidy</code> code.</p>
<p>This article will discuss briefly:</p>
<ul>
<li>How <code>LibTidy</code> achieves namespacing in C</li>
<li>Explanations for some of the bizzarre, do-nothing macros.</li>
<li>Opaque types</li>
<li>How to add new functions to the <code>LibTidy</code> API.</li>
</ul>
<h1>Namespacing</h1>
<p>The C language does not support built in namespacing, but it is subject to namespace collision, especially when a library is statically linked. <code>LibTidy</code> tries to get around this by making a compromise between human-readable names and making the names random enough to avoid a collision.</p>
<p>As you browse Tidy's code, you'll notice many uses of a macro function – <code><a class="el" href="forward_8h.html#afe4399ce3d59fdbba5127cb28fd18ef8">TY_()</a></code> – applied to the function names of non-static functions. The preprocessor thus resolves all of these function names to <code>prvTidyFunction</code>, thus ensuring a clear namespace and avoiding the possibility of collisions (unless some other library has thoughtlessly borrowed our prefix for the same). For example, <code><a class="el" href="forward_8h.html#afe4399ce3d59fdbba5127cb28fd18ef8">TY_(getNextOptionPick)</a></code> will resolve to <code>prvTidygetNextOptionPick</code> when compiled.</p>
<p>Of course, <code>static</code> functions are immune to the issue of namespace pollution, so in general you will really only use this technique for functions that must be accessible from outside of your new file, such as functions that you want to expose to the API.</p>
<h1>Macros for documentation</h1>
<p><code>TIDY_EXPORT</code> and <code>TIDY_CALL</code> are defined to be <code>NULL</code>, i.e., when compiled they resolve to nothing. These are used exclusively for documenting functions that are part of the API defined in <code><a class="el" href="tidy_8h.html" title="Defines HTML Tidy public API implemented by LibTidy. ">tidy.h</a></code> and the implementation in <code>tidylib.c</code>. For example, in <code><a class="el" href="tidy_8h.html" title="Defines HTML Tidy public API implemented by LibTidy. ">tidy.h</a></code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TIDY_EXPORT TidyIterator TIDY_CALL getWindowsLanguageList();</div></div><!-- fragment --><p>The <code>TIDY_EXPORT</code> call clearly indicates that this function prototype is meant to be exported from the API, and <code>TIDY_CALL</code> clearly indicates that the function is called from within <code>LibTidy</code>.</p>
<p>Although this makes things obvious from the documentation perspective, the truth is a little murkier. In some environments one might define <code>TIDY_EXPORT</code> and <code>TIDY_CALL</code> differently in order to control compiler behavior, especially in environments that have special requirements for dynamic libraries. In general, though, you shouldn't have to worry about this.</p>
<p>The preferred use of pointer operators when documenting with macros is this:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;const tidyLocaleMapItem* TIDY_CALL getNextWindowsLanguage( TidyIterator* iter )</div></div><!-- fragment --><p>…instead of this:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;const tidyLocaleMapItem TIDY_CALL *getNextWindowsLanguage( TidyIterator* iter )</div></div><!-- fragment --><h1>External types are opaque</h1>
<p>In several spots the source code indicates that a particular structure is "opaque." This simply means that API users cannot see inside of them, and they have to depend on accessor functions to gain access to the sweet fruit that is within. This is a design choice that makes <code>LibTidy</code> highly portable and makes it accessible to multitudes of other languages that can communicate with a C API.</p>
<p>Take <code>tidyDoc</code> for example, as it's the most fundamental datatype within <code>LibTidy</code>. As an API user, you can have a reference to a <code>tidyDoc</code>, and you're going to pass it around a lot to accessor functions (such as <code>tidyCleanAndRepair</code>), and you know that it contains lots of good stuff, but you're not allowed to peek inside of it unless an accessor function is provided. Think of it as a token that you pass around, and nothing more.</p>
<p>Internally, the type is cast to a native C structure of type <code>tidyDocImpl</code>, and so if you decide to become a Tidy developer, you have the choice to access the item fully.</p>
<p>If you extend Tidy's API, it's important to respect this design choice, even if only writing functionality for the console application (which is, of course, simply an implementor of <code>LibTidy</code>).</p>
<h1>How to add new functions to <code>LibTidy</code></h1>
<p>All of the information above is useful for anyone who wants to browse Tidy's source code, or use the API, or understand Tidy better, but it all comes together nicely when you want to extend the API. This quick lesson will show you how to do so, using <code><a class="el" href="group__Localization.html#ga3b1ffd42b71e28881de8dea41d6930f2" title="Provides a string given messageType in the current localization for the single case. ">tidyLocalizedString()</a></code> as an example.</p>
<h2>Behind the scenes</h2>
<p>The first thing we need to do is have the internal version of the function that we want to add. Tidy has a module that handles localization: <code><a class="el" href="language_8h.html">language.h</a>/c</code>. In the header is where we define the interface to LibTidy, which should be namespaced according to the discussion above. We can declare:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;ctmbstr TY_(tidyLocalizedString)( uint messageType );</div></div><!-- fragment --><p>…and of course implement it in the <code>.c</code> file.</p>
<p>Now you have a decision to make: if you plan to use this function internally, you're going to have to import the header into other modules that require the function. This can lead to painful compile-time consequences. However since we want to expose this particular function to the API, it will be visible within <code>TidyLib</code>, so we can use the public API internally, too.</p>
<h2>The API</h2>
<p>Once implemented, we want a pretty, public-facing name for our <code><a class="el" href="group__Localization.html#ga3b1ffd42b71e28881de8dea41d6930f2" title="Provides a string given messageType in the current localization for the single case. ">tidyLocalizedString()</a></code> function, which appropriately is <code><a class="el" href="group__Localization.html#ga3b1ffd42b71e28881de8dea41d6930f2" title="Provides a string given messageType in the current localization for the single case. ">tidyLocalizedString()</a></code>. Add the declaration to <code><a class="el" href="tidy_8h.html" title="Defines HTML Tidy public API implemented by LibTidy. ">tidy.h</a></code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TIDY_EXPORT ctmbstr TIDY_CALL tidyLocalizedString( uint messageType );</div></div><!-- fragment --><p>…and now the publicly exposed interface knows that your function exists. All that's left to do is add the <code><a class="el" href="language_8h.html">language.h</a></code> header to <code>tidylib.c</code>, and then implement it there:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;ctmbstr TIDY_CALL tidyLocalizedString( uint messageType )</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;{</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    return TY_(tidyLocalizedString)( messageType );</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;}</div></div><!-- fragment --><p>Congratulations, you can now expose new functionality to the API.</p>
<h2>API functions for opaque types</h2>
<p>For a more complicated example that demonstrates how to use opaque types (and also the <code>TidyIterator</code> type) have a look at the implementation of <code><a class="el" href="group__Localization.html#gad02a58a776e155f05476551afff61732" title="Initiates an iterator for a list of Tidy&#39;s Windows&lt;-&gt;POSIX locale mappings. ">getWindowsLanguageList()</a></code>, and its partners <code>*getNextWindowsLanguage()</code>, <code><a class="el" href="group__Localization.html#gad7702aa4bcb577235a27e78f06091f31" title="Given a tidyLocalMapItem, return the Windows name. ">TidyLangWindowsName()</a></code>, and <code><a class="el" href="group__Localization.html#ga6c79e2784181698a89a2681667726c7b" title="Given a tidyLocalMapItem, return the POSIX name. ">TidyLangPosixName()</a></code>. These demonstrate how to:</p>
<ul>
<li>implement iteration for structures with multiple records.</li>
<li>write a function in <code>tidylib.c</code> that converts between the exposed, opaque type and the internal, implementation type.</li>
<li>further reinforce how functionality is added to the API. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Oct 19 2017 20:27:40 for HTML Tidy by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
